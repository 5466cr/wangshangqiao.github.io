<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿å˜æ¸¸æˆ - Coup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#7c3aed',
                        accent: '#f59e0b',
                        danger: '#dc2626',
                        success: '#16a34a',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            .card-flip {
                perspective: 1000px;
            }
            .card-inner {
                transition: transform 0.6s;
                transform-style: preserve-3d;
            }
            .card-flip:hover .card-inner {
                transform: rotateY(180deg);
            }
            .card-front, .card-back {
                backface-visibility: hidden;
            }
            .card-back {
                transform: rotateY(180deg);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-white">
    <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- æ¬¢è¿é¡µé¢ -->
        <div id="welcome-screen" class="text-center">
            <div class="mb-8">
                <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">æ”¿å˜æ¸¸æˆ</h1>
                <p class="text-xl text-gray-300">ç»å…¸çš„ç¤¾äº¤æ¨ç†ç­–ç•¥æ¸¸æˆ</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
                <!-- åˆ›å»ºæˆ¿é—´ -->
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700 hover:border-blue-500 transition-all">
                    <h2 class="text-2xl font-semibold mb-4">åˆ›å»ºæˆ¿é—´</h2>
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="create-name" 
                            placeholder="è¾“å…¥ä½ çš„åå­—" 
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <button 
                            id="create-room-btn" 
                            class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 rounded-lg font-semibold transition-all transform hover:scale-105"
                        >
                            åˆ›å»ºæˆ¿é—´
                        </button>
                    </div>
                </div>

                <!-- åŠ å…¥æˆ¿é—´ -->
                <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700 hover:border-purple-500 transition-all">
                    <h2 class="text-2xl font-semibold mb-4">åŠ å…¥æˆ¿é—´</h2>
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="join-code" 
                            placeholder="è¾“å…¥æˆ¿é—´ä»£ç " 
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >
                        <input 
                            type="text" 
                            id="join-name" 
                            placeholder="è¾“å…¥ä½ çš„åå­—" 
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >
                        <button 
                            id="join-room-btn" 
                            class="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 rounded-lg font-semibold transition-all transform hover:scale-105"
                        >
                            åŠ å…¥æˆ¿é—´
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æˆ¿é—´ç­‰å¾…é¡µé¢ -->
        <div id="room-screen" class="hidden">
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">æˆ¿é—´ä»£ç : <span id="room-code-display" class="text-accent font-mono">ABC123</span></h2>
                        <p class="text-gray-300">ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥...</p>
                    </div>
                    <button id="copy-code-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all">
                        <i class="fa fa-copy mr-2"></i>å¤åˆ¶ä»£ç 
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- ç©å®¶åˆ—è¡¨ -->
                    <div class="lg:col-span-1">
                        <h3 class="text-xl font-semibold mb-4">ç©å®¶åˆ—è¡¨ (<span id="player-count">0</span>/6)</h3>
                        <div id="players-list" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- ç©å®¶é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- æ¸¸æˆä¿¡æ¯ -->
                    <div class="lg:col-span-2">
                        <div class="bg-gray-700 rounded-lg p-4 mb-4">
                            <h3 class="text-lg font-semibold mb-2">æ¸¸æˆè§„åˆ™</h3>
                            <div class="text-sm text-gray-300 space-y-2 max-h-40 overflow-y-auto">
                                <p><strong>åŸºæœ¬è¡ŒåŠ¨:</strong> æ”¶å…¥(+1é‡‘å¸)ã€å¤–å›½æ´åŠ©(+2é‡‘å¸)ã€æ”¿å˜(-7é‡‘å¸)</p>
                                <p><strong>è§’è‰²æŠ€èƒ½:</strong></p>
                                <ul class="list-disc pl-5">
                                    <li><strong>å…¬çˆµ:</strong> å¾ç¨(+3é‡‘å¸)ï¼Œé˜»æ­¢å¤–å›½æ´åŠ©</li>
                                    <li><strong>åˆºå®¢:</strong> åˆºæ€(-3é‡‘å¸)ï¼Œç›®æ ‡å¼ƒä¸€å¼ ç‰Œ</li>
                                    <li><strong>å¤§ä½¿:</strong> äº¤æ¢å¡ç‰Œï¼Œé˜»æ­¢å·çªƒ</li>
                                    <li><strong>ä¸Šå°‰:</strong> å·çªƒ(+2é‡‘å¸)ï¼Œé˜»æ­¢å·çªƒ</li>
                                    <li><strong>å¥³çˆµ:</strong> å…ç–«åˆºæ€</li>
                                </ul>
                                <p><strong>èƒœåˆ©æ¡ä»¶:</strong> æˆä¸ºæœ€åä¸€ä¸ªå­˜æ´»çš„ç©å®¶</p>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <button id="leave-room-btn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all">
                                <i class="fa fa-sign-out mr-2"></i>ç¦»å¼€æˆ¿é—´
                            </button>
                            <button id="start-game-btn" class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 rounded-lg font-semibold transition-all transform hover:scale-105">
                                å¼€å§‹æ¸¸æˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <div id="game-screen" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- å·¦ä¾§ç©å®¶ä¿¡æ¯ -->
                <div class="lg:col-span-1">
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4">ç©å®¶ä¿¡æ¯</h3>
                        <div id="current-player-info" class="mb-6 p-4 bg-gray-700 rounded-lg border-2 border-blue-500">
                            <div class="flex justify-between items-center mb-2">
                                <span id="current-player-name" class="font-bold text-lg">ä½ </span>
                                <span id="current-player-coins" class="text-accent text-xl">ğŸ’° 5</span>
                            </div>
                            <div class="flex space-x-2 mb-2">
                                <div class="w-12 h-16 bg-blue-900 rounded-lg border border-blue-300 flex items-center justify-center">
                                    <span class="text-2xl">?</span>
                                </div>
                                <div class="w-12 h-16 bg-blue-900 rounded-lg border border-blue-300 flex items-center justify-center">
                                    <span class="text-2xl">?</span>
                                </div>
                            </div>
                            <div class="text-sm text-gray-300">
                                <span id="player-role-hint" class="italic">ä½ çš„è§’è‰²åªæœ‰ä½ çŸ¥é“</span>
                            </div>
                        </div>

                        <div id="other-players" class="space-y-3 max-h-80 overflow-y-auto">
                            <!-- å…¶ä»–ç©å®¶ä¿¡æ¯ -->
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§æ¸¸æˆåŒºåŸŸ -->
                <div class="lg:col-span-3">
                    <!-- æ¸¸æˆæ—¥å¿— -->
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700 mb-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fa fa-history mr-2 text-blue-400"></i>
                            æ¸¸æˆæ—¥å¿—
                        </h3>
                        <div id="game-log" class="h-32 overflow-y-auto bg-gray-900 bg-opacity-50 rounded-lg p-4 text-sm space-y-2">
                            <!-- æ—¥å¿—å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                        </div>
                    </div>

                    <!-- æ¸¸æˆçŠ¶æ€ -->
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-semibold">æ¸¸æˆçŠ¶æ€</h3>
                                <p id="game-status-text" class="text-gray-300">å›åˆ 1 - ç­‰å¾…ç©å®¶è¡ŒåŠ¨</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-400">ç‰Œå †å‰©ä½™</div>
                                <div id="deck-count" class="text-lg">ğŸƒ 15</div>
                            </div>
                        </div>

                        <div id="game-log" class="bg-gray-700 rounded-lg p-4 h-32 overflow-y-auto text-sm space-y-1 mb-4">
                            <!-- æ¸¸æˆæ—¥å¿— -->
                        </div>

                        <!-- æŒ‘æˆ˜é˜¶æ®µ -->
                        <div id="challenge-phase" class="hidden bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-yellow-400">æŒ‘æˆ˜é˜¶æ®µ</h4>
                                <div id="challenge-countdown" class="text-yellow-400 font-mono text-lg">
                                    <i class="fa fa-clock-o mr-1"></i>
                                    <span id="countdown-timer">20</span>ç§’
                                </div>
                            </div>
                            <p id="challenge-text" class="text-sm mb-3">æœ‰äººè´¨ç–‘äº†è¿™ä¸ªè¡ŒåŠ¨ï¼ä½ è¦æŒ‘æˆ˜å—ï¼Ÿ</p>
                            <div class="flex space-x-3">
                                <button id="challenge-yes-btn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition-all">
                                    æŒ‘æˆ˜
                                </button>
                                <button id="challenge-no-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-all">
                                    ä¸æŒ‘æˆ˜
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ååˆ¶é˜¶æ®µ -->
                    <div id="counteraction-phase" class="hidden bg-purple-900 bg-opacity-30 border border-purple-600 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-purple-400">ååˆ¶é˜¶æ®µ</h4>
                            <div id="counteraction-countdown" class="text-purple-400 font-mono text-lg">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span id="counteraction-timer">15</span>ç§’
                            </div>
                        </div>
                        <p id="counteraction-text" class="text-sm mb-3">ä½ å¯ä»¥ååˆ¶è¿™ä¸ªè¡ŒåŠ¨å—ï¼Ÿ</p>
                        <div class="flex space-x-3">
                            <button id="counteraction-yes-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg transition-all">
                                ååˆ¶
                            </button>
                            <button id="counteraction-no-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-all">
                                ä¸ååˆ¶
                            </button>
                        </div>
                    </div>

                    <!-- è¡ŒåŠ¨æŒ‰é’® -->
                    <div id="action-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <button class="action-btn bg-blue-600 hover:bg-blue-500 p-4 rounded-xl transition-all flex flex-col items-center" data-action="income">
                            <i class="fa fa-plus-circle text-2xl mb-2"></i>
                            <span class="font-semibold">æ”¶å…¥</span>
                            <span class="text-xs text-gray-300">+1 é‡‘å¸</span>
                        </button>
                        <button class="action-btn bg-green-600 hover:bg-green-500 p-4 rounded-xl transition-all flex flex-col items-center" data-action="foreign_aid">
                            <i class="fa fa-globe text-2xl mb-2"></i>
                            <span class="font-semibold">å¤–å›½æ´åŠ©</span>
                            <span class="text-xs text-gray-300">+2 é‡‘å¸</span>
                        </button>
                        <button class="action-btn bg-red-600 hover:bg-red-500 p-4 rounded-xl transition-all flex flex-col items-center" data-action="coup">
                            <i class="fa fa-bolt text-2xl mb-2"></i>
                            <span class="font-semibold">æ”¿å˜</span>
                            <span class="text-xs text-gray-300">-7 é‡‘å¸</span>
                        </button>
                        <button class="action-btn bg-purple-600 hover:bg-purple-500 p-4 rounded-xl transition-all flex flex-col items-center" data-action="tax">
                            <i class="fa fa-money text-2xl mb-2"></i>
                            <span class="font-semibold">å¾ç¨</span>
                            <span class="text-xs text-gray-300">å…¬çˆµæŠ€èƒ½</span>
                        </button>
                        <button class="action-btn bg-orange-600 hover:bg-orange-500 p-4 rounded-xl transition-all flex flex-col items-center" data-action="assassinate">
                            <i class="fa fa-crosshairs text-2xl mb-2"></i>
                            <span class="font-semibold">åˆºæ€</span>
                            <span class="text-xs text-gray-300">-3 é‡‘å¸</span>
                        </button>
                        <button class="action-btn bg-teal-600 hover:bg-teal-500 p-4 rounded-xl transition-all flex flex-col items-center" data-action="exchange">
                            <i class="fa fa-exchange text-2xl mb-2"></i>
                            <span class="font-semibold">äº¤æ¢</span>
                            <span class="text-xs text-gray-300">å¤§ä½¿æŠ€èƒ½</span>
                        </button>
                        <button class="action-btn bg-indigo-600 hover:bg-indigo-500 p-4 rounded-xl transition-all flex flex-col items-center" data-action="steal">
                            <i class="fa fa-hand-paper-o text-2xl mb-2"></i>
                            <span class="font-semibold">å·çªƒ</span>
                            <span class="text-xs text-gray-300">ä¸Šå°‰æŠ€èƒ½</span>
                        </button>
                    </div>

                    <!-- ç›®æ ‡é€‰æ‹© -->
                    <div id="target-selection" class="hidden bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700 mb-6">
                        <h3 class="text-xl font-semibold mb-4">é€‰æ‹©ç›®æ ‡ç©å®¶</h3>
                        <div id="target-players" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- ç›®æ ‡ç©å®¶æŒ‰é’® -->
                        </div>
                        <button id="cancel-target-btn" class="mt-4 px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-all">
                            å–æ¶ˆ
                        </button>
                    </div>

                    <!-- å¼ƒç‰Œé€‰æ‹© -->
                    <div id="discard-selection" class="hidden bg-red-900 bg-opacity-30 border border-red-600 rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-semibold text-red-400 mb-4">é€‰æ‹©å¼ƒç‰Œ</h3>
                        <p id="discard-text" class="text-gray-300 mb-4">ä½ éœ€è¦é€‰æ‹©ä¸€å¼ å¡ç‰Œå¼ƒæ‰</p>
                        <div id="discard-cards" class="grid grid-cols-2 gap-4 mb-4">
                            <!-- å¼ƒç‰Œé€‰æ‹©æŒ‰é’® -->
                        </div>
                    </div>

                    <!-- èŠå¤©åŒºåŸŸ -->
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4">èŠå¤©</h3>
                        <div id="chat-messages" class="bg-gray-700 rounded-lg p-4 h-40 overflow-y-auto text-sm space-y-2 mb-4">
                            <!-- èŠå¤©æ¶ˆæ¯ -->
                        </div>
                        <div class="flex space-x-2">
                            <input 
                                type="text" 
                                id="chat-input" 
                                placeholder="è¾“å…¥æ¶ˆæ¯..." 
                                class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                            <button id="send-chat-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition-all">
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <div id="game-over-screen" class="hidden text-center">
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-xl p-8 border border-gray-700 max-w-2xl mx-auto">
                <h2 class="text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-600">æ¸¸æˆç»“æŸï¼</h2>
                <div id="winner-info" class="text-2xl font-semibold mb-8">
                    èƒœåˆ©è€…: <span id="winner-name" class="text-yellow-400">ç©å®¶åç§°</span>
                </div>
                <div class="space-y-4">
                    <button id="play-again-btn" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 rounded-lg font-semibold transition-all transform hover:scale-105">
                        å†æ¥ä¸€å±€
                    </button>
                    <button id="back-to-menu-btn" class="px-8 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all">
                        è¿”å›ä¸»èœå•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„æ¸¸æˆçŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            const savedRoomCode = localStorage.getItem('coup_roomCode');
            const savedPlayerId = localStorage.getItem('coup_playerId');
            const savedPlayerName = localStorage.getItem('coup_playerName');
            
            if (savedRoomCode && savedPlayerId && savedPlayerName) {
                // æ˜¾ç¤ºé‡è¿æç¤º
                const reconnectConfirm = confirm(`æ£€æµ‹åˆ°ä½ ä¹‹å‰åœ¨æˆ¿é—´ ${savedRoomCode} ä¸­æœ‰æœªå®Œæˆçš„æ¸¸æˆï¼Œæ˜¯å¦é‡æ–°è¿æ¥ï¼Ÿ`);
                if (reconnectConfirm) {
                    // ç›´æ¥åˆå§‹åŒ–æ¸¸æˆå¹¶å°è¯•é‡è¿
                    window.coupGame = new CoupGame();
                    setTimeout(() => {
                        window.coupGame.reconnectToGame(savedRoomCode, savedPlayerId, savedPlayerName);
                    }, 100);
                    return;
                } else {
                    // æ¸…é™¤å­˜å‚¨çš„ä¿¡æ¯
                    localStorage.removeItem('coup_roomCode');
                    localStorage.removeItem('coup_playerId');
                    localStorage.removeItem('coup_playerName');
                }
            }
            
            // æ­£å¸¸åˆå§‹åŒ–æ¸¸æˆ
            window.coupGame = new CoupGame();
        });

        class CoupGame {
            constructor() {
                this.socket = null;
                this.currentRoom = null;
                this.currentPlayer = null;
                this.gameState = null;
                this.currentAction = null;
                this.currentTarget = null;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.showScreen('welcome-screen');
            }

            bindEvents() {
                // åˆ›å»ºæˆ¿é—´
                document.getElementById('create-room-btn').addEventListener('click', () => this.createRoom());
                
                // åŠ å…¥æˆ¿é—´
                document.getElementById('join-room-btn').addEventListener('click', () => this.joinRoom());
                
                // ç¦»å¼€æˆ¿é—´
                document.getElementById('leave-room-btn').addEventListener('click', () => this.leaveRoom());
                
                // å¼€å§‹æ¸¸æˆ
                document.getElementById('start-game-btn').addEventListener('click', () => this.startGame());
                
                // å¤åˆ¶æˆ¿é—´ä»£ç 
                document.getElementById('copy-code-btn').addEventListener('click', () => this.copyRoomCode());
                
                // è¡ŒåŠ¨æŒ‰é’®
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleAction(e.target.dataset.action));
                });
                
                // æŒ‘æˆ˜æŒ‰é’®
                document.getElementById('challenge-yes-btn').addEventListener('click', () => this.handleChallenge(true));
                document.getElementById('challenge-no-btn').addEventListener('click', () => this.handleChallenge(false));
                
                // ååˆ¶æŒ‰é’®
                document.getElementById('counteraction-yes-btn').addEventListener('click', () => this.handleCounteraction(true));
                document.getElementById('counteraction-no-btn').addEventListener('click', () => this.handleCounteraction(false));
                
                // å–æ¶ˆç›®æ ‡é€‰æ‹©
                document.getElementById('cancel-target-btn').addEventListener('click', () => this.cancelTargetSelection());
                
                // èŠå¤©
                document.getElementById('send-chat-btn').addEventListener('click', () => this.sendChatMessage());
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChatMessage();
                });
                
                // å†æ¥ä¸€å±€
                document.getElementById('play-again-btn').addEventListener('click', () => this.playAgain());
                
                // è¿”å›ä¸»èœå•
                document.getElementById('back-to-menu-btn').addEventListener('click', () => this.backToMenu());
            }

            async createRoom() {
                const playerName = document.getElementById('create-name').value.trim();
                if (!playerName) {
                    this.showError('è¯·è¾“å…¥ä½ çš„åå­—');
                    return;
                }

                try {
                    const response = await fetch('http://localhost:3001/api/game/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ playerName })
                    });
                    const data = await response.json();

                    if (data.success) {
                        this.currentPlayer = {
                            id: data.playerId,
                            name: playerName,
                            isHost: true
                        };
                        this.connectToSocket();
                        this.joinSocketRoom(data.roomCode, playerName, data.playerId);
                        this.currentRoom = data.roomCode;
                        this.updateRoomScreen(data.roomCode, [this.currentPlayer]);
                    } else {
                        this.showError(data.message || 'åˆ›å»ºæˆ¿é—´å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ›å»ºæˆ¿é—´é”™è¯¯:', error);
                    this.showError('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
                }
            }

            async joinRoom() {
                const roomCode = document.getElementById('join-code').value.trim().toUpperCase();
                const playerName = document.getElementById('join-name').value.trim();
                
                if (!roomCode || !playerName) {
                    this.showError('è¯·è¾“å…¥æˆ¿é—´ä»£ç å’Œåå­—');
                    return;
                }

                try {
                    const response = await fetch('http://localhost:3001/api/game/join', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomCode, playerName })
                    });
                    const data = await response.json();

                    if (data.success) {
                        this.currentPlayer = {
                            id: null, // å°†åœ¨socketè¿æ¥åè·å–
                            name: playerName,
                            isHost: false
                        };
                        
                        // å­˜å‚¨æ¸¸æˆä¿¡æ¯åˆ°localStorage
                        this.saveGameState(roomCode, null, playerName);
                        
                        // ç«‹å³æ›´æ–°æˆ¿é—´ç•Œé¢ï¼Œæ˜¾ç¤ºå½“å‰ç©å®¶åˆ—è¡¨
                        this.updateRoomScreen(roomCode, data.players);
                        
                        this.connectToSocket();
                        this.joinSocketRoom(roomCode, playerName, null);
                        this.currentRoom = roomCode;
                    } else {
                        this.showError(data.message || 'åŠ å…¥æˆ¿é—´å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ å…¥æˆ¿é—´é”™è¯¯:', error);
                    this.showError('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
                }
            }

            connectToSocket() {
                this.socket = io('ws://localhost:3001');

                this.socket.on('connect', () => {
                    console.log('Socketè¿æ¥æˆåŠŸ');
                });

                this.socket.on('joinRoomSuccess', (data) => {
                    console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
                    if (!this.currentPlayer.id) {
                        this.currentPlayer.id = data.playerId;
                        this.currentPlayer.isHost = data.isHost;
                        
                        // æ›´æ–°localStorageä¸­çš„playerId
                        localStorage.setItem('coup_playerId', data.playerId);
                    }
                    this.updateRoomScreen(this.currentRoom, data.players);
                });

                this.socket.on('playerJoined', (data) => {
                    console.log('ç©å®¶åŠ å…¥:', data);
                    this.updateRoomScreen(this.currentRoom, data.players);
                    this.addGameLog(`${data.newPlayer.name} åŠ å…¥äº†æ¸¸æˆ`);
                });

                this.socket.on('playerLeft', (data) => {
                    console.log('ç©å®¶ç¦»å¼€:', data);
                    this.updateRoomScreen(this.currentRoom, data.players);
                    this.addGameLog(`${data.playerName} ç¦»å¼€äº†æ¸¸æˆ`);
                });

                this.socket.on('gameStarted', (data) => {
                    console.log('æ¸¸æˆå¼€å§‹:', data);
                    this.gameState = data.gameState;
                    this.startGameUI();
                });

                this.socket.on('gameStateUpdate', (data) => {
                    console.log('æ¸¸æˆçŠ¶æ€æ›´æ–°:', data);
                    this.gameState = data.gameState;
                    this.updateGameUI(data.actionResult);
                });

                this.socket.on('challengeResult', (data) => {
                    console.log('æŒ‘æˆ˜ç»“æœ:', data);
                    this.gameState = data.gameState;
                    this.handleChallengeResult(data.challengeResult);
                });

                this.socket.on('challengeCountdownUpdate', (data) => {
                    console.log('æŒ‘æˆ˜å€’è®¡æ—¶æ›´æ–°:', data);
                    this.updateChallengeCountdown(data.countdown);
                });

                this.socket.on('counteractionRequested', (data) => {
                    console.log('ååˆ¶è¯·æ±‚:', data);
                    this.addGameLog(data.message, 'counter');
                    this.showCounteractionPhase(data);
                });

                this.socket.on('counteractionCountdownUpdate', (data) => {
                    console.log('ååˆ¶å€’è®¡æ—¶æ›´æ–°:', data);
                    this.updateCounteractionCountdown(data.countdown);
                });

                this.socket.on('discardResult', (data) => {
                    console.log('å¼ƒç‰Œç»“æœ:', data);
                    this.gameState = data.gameState;
                    this.handleDiscardResult(data.discardResult);
                });

                this.socket.on('blockAction', (data) => {
                    console.log('ååˆ¶è¡ŒåŠ¨:', data);
                    this.addGameLog(data.message, 'counter');
                    this.showBlockPhase(data);
                });

                this.socket.on('blockCountdownUpdate', (data) => {
                    console.log('ååˆ¶å€’è®¡æ—¶æ›´æ–°:', data);
                    this.updateBlockCountdown(data.countdown);
                });

                this.socket.on('cardSwapped', (data) => {
                    console.log('å¡ç‰Œäº¤æ¢:', data);
                    this.addGameLog(data.message, 'info');
                    this.handleCardSwapped(data);
                });
                });

                this.socket.on('chatMessage', (data) => {
                    console.log('èŠå¤©æ¶ˆæ¯:', data);
                    this.addChatMessage(data);
                });

                this.socket.on('error', (data) => {
                    console.error('Socketé”™è¯¯:', data);
                    this.showError(data.message || 'å‘ç”Ÿé”™è¯¯');
                });

                this.socket.on('disconnect', () => {
                    console.log('Socketæ–­å¼€è¿æ¥');
                    this.showError('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                });
            }

            joinSocketRoom(roomCode, playerName, playerId) {
                this.socket.emit('joinRoom', { roomCode, playerName, playerId });
            }

            leaveRoom() {
                if (this.socket) {
                    this.socket.emit('leaveRoom', { 
                        roomCode: this.currentRoom, 
                        playerId: this.currentPlayer?.id 
                    });
                    this.socket.disconnect();
                }
                
                // æ¸…é™¤å­˜å‚¨çš„æ¸¸æˆä¿¡æ¯
                this.clearGameState();
                
                this.currentRoom = null;
                this.currentPlayer = null;
                this.gameState = null;
                this.showScreen('welcome-screen');
            }

            startGame() {
                if (!this.currentPlayer?.isHost) {
                    this.showError('åªæœ‰æˆ¿ä¸»å¯ä»¥å¼€å§‹æ¸¸æˆ');
                    return;
                }

                this.socket.emit('startGame', { 
                    roomCode: this.currentRoom, 
                    playerId: this.currentPlayer.id 
                });
            }

            handleAction(action) {
                if (!this.gameState || this.gameState.status !== 'playing') return;
                if (this.gameState.currentPlayer !== this.currentPlayer.id) {
                    this.showError('ç°åœ¨ä¸æ˜¯ä½ çš„å›åˆ');
                    return;
                }

                const player = this.gameState.players.find(p => p.id === this.currentPlayer.id);
                if (!player || !player.isAlive) return;

                // æ£€æŸ¥é‡‘å¸è¦æ±‚
                if (action === 'coup' && player.coins < 7) {
                    this.showError('é‡‘å¸ä¸è¶³ï¼ˆéœ€è¦7é‡‘å¸ï¼‰');
                    return;
                }
                if (action === 'assassinate' && player.coins < 3) {
                    this.showError('é‡‘å¸ä¸è¶³ï¼ˆéœ€è¦3é‡‘å¸ï¼‰');
                    return;
                }

                // éœ€è¦é€‰æ‹©ç›®æ ‡çš„è¡ŒåŠ¨
                const targetActions = ['coup', 'assassinate', 'steal'];
                if (targetActions.includes(action)) {
                    this.currentAction = action;
                    this.showTargetSelection();
                    return;
                }

                // ç›´æ¥æ‰§è¡Œçš„è¡ŒåŠ¨
                this.executeAction(action);
            }

            showTargetSelection() {
                const targetPlayers = this.gameState.players.filter(p => 
                    p.id !== this.currentPlayer.id && p.isAlive
                );

                const targetContainer = document.getElementById('target-players');
                targetContainer.innerHTML = '';

                targetPlayers.forEach(player => {
                    const btn = document.createElement('button');
                    btn.className = 'target-btn bg-gray-700 hover:bg-gray-600 p-4 rounded-xl transition-all flex flex-col items-center';
                    btn.innerHTML = `
                        <span class="font-semibold">${player.name}</span>
                        <span class="text-sm text-gray-300">ğŸ’° ${player.coins}</span>
                        <div class="flex space-x-1 mt-2">
                            ${Array(player.cardsCount).fill().map(() => '<span class="text-sm">?</span>').join('')}
                        </div>
                    `;
                    btn.addEventListener('click', () => {
                        this.currentTarget = player.id;
                        this.executeAction(this.currentAction, player.id);
                        this.hideTargetSelection();
                    });
                    targetContainer.appendChild(btn);
                });

                document.getElementById('target-selection').classList.remove('hidden');
            }

            hideTargetSelection() {
                document.getElementById('target-selection').classList.add('hidden');
                this.currentAction = null;
                this.currentTarget = null;
            }

            cancelTargetSelection() {
                this.hideTargetSelection();
            }

            executeAction(action, targetPlayerId = null) {
                this.socket.emit('playerAction', {
                    roomCode: this.currentRoom,
                    playerId: this.currentPlayer.id,
                    action,
                    targetPlayerId
                });
            }

            handleChallenge(challenge) {
                this.socket.emit('challengeAction', {
                    roomCode: this.currentRoom,
                    playerId: this.currentPlayer.id,
                    challenge
                });
                document.getElementById('challenge-phase').classList.add('hidden');
            }

            handleChallengeResult(result) {
                result.log.forEach(log => this.addGameLog(log));
            }

            sendChatMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                if (!message) return;

                this.socket.emit('chatMessage', {
                    roomCode: this.currentRoom,
                    playerId: this.currentPlayer.id,
                    message
                });

                input.value = '';
            }

            addChatMessage(data) {
                const chatContainer = document.getElementById('chat-messages');
                const messageEl = document.createElement('div');
                messageEl.className = data.sender.id === this.currentPlayer.id ? 'text-right' : 'text-left';
                messageEl.innerHTML = `
                    <span class="font-semibold ${data.sender.id === this.currentPlayer.id ? 'text-blue-400' : 'text-green-400'}">
                        ${data.sender.name}:
                    </span>
                    <span class="ml-2">${this.escapeHtml(data.message)}</span>
                `;
                chatContainer.appendChild(messageEl);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            addGameLog(message, type = 'info') {
                const logContainer = document.getElementById('game-log');
                const logEntry = document.createElement('div');
                
                let textColor = 'text-gray-300';
                let icon = 'fa-circle';
                
                switch (type) {
                    case 'success':
                        textColor = 'text-green-400';
                        icon = 'fa-check-circle';
                        break;
                    case 'error':
                        textColor = 'text-red-400';
                        icon = 'fa-exclamation-circle';
                        break;
                    case 'warning':
                        textColor = 'text-yellow-400';
                        icon = 'fa-exclamation-triangle';
                        break;
                    case 'action':
                        textColor = 'text-blue-400';
                        icon = 'fa-bolt';
                        break;
                    case 'counter':
                        textColor = 'text-purple-400';
                        icon = 'fa-shield';
                        break;
                    case 'challenge':
                        textColor = 'text-orange-400';
                        icon = 'fa-question-circle';
                        break;
                }
                
                logEntry.className = `flex items-start ${textColor} mb-1`;
                logEntry.innerHTML = `
                    <i class="fa ${icon} mr-2 mt-1"></i>
                    <span>${message}</span>
                `;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡å¹¶æ¸…ç†é‡å¤
                this.cleanupLogs(logContainer);
            }

            cleanupLogs(logContainer) {
                // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
                if (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
                
                // ç®€å•çš„é‡å¤æ¸…ç†é€»è¾‘
                const logs = Array.from(logContainer.children);
                for (let i = logs.length - 1; i > 0; i--) {
                    if (logs[i].textContent === logs[i-1].textContent) {
                        logContainer.removeChild(logs[i]);
                    }
                }
            }

            updateRoomScreen(roomCode, players) {
                document.getElementById('room-code-display').textContent = roomCode;
                document.getElementById('player-count').textContent = players.length;

                const playersList = document.getElementById('players-list');
                playersList.innerHTML = '';

                players.forEach(player => {
                    const playerEl = document.createElement('div');
                    playerEl.className = `p-3 bg-gray-700 rounded-lg flex justify-between items-center ${player.isHost ? 'border border-yellow-500' : ''}`;
                    playerEl.innerHTML = `
                        <div class="flex items-center">
                            <i class="fa fa-user-circle text-xl mr-2 ${player.isHost ? 'text-yellow-400' : 'text-blue-400'}"></i>
                            <span class="font-semibold">${player.name}</span>
                            ${player.isHost ? '<span class="ml-2 text-xs bg-yellow-500 text-yellow-900 px-2 py-1 rounded">æˆ¿ä¸»</span>' : ''}
                        </div>
                        <span class="text-accent">ğŸ’° ${player.coins || 2}</span>
                    `;
                    playersList.appendChild(playerEl);
                });

                // å¯ç”¨/ç¦ç”¨å¼€å§‹æ¸¸æˆæŒ‰é’®
                const startBtn = document.getElementById('start-game-btn');
                const isHost = this.currentPlayer?.isHost;
                const hasEnoughPlayers = players.length >= 2;
                
                startBtn.disabled = !isHost || !hasEnoughPlayers;
                startBtn.classList.toggle('opacity-50', !isHost || !hasEnoughPlayers);

                this.showScreen('room-screen');
            }

            startGameUI() {
                this.updateGameUI();
                this.showScreen('game-screen');
                this.addGameLog('æ¸¸æˆå¼€å§‹ï¼');
                this.addGameLog(`å½“å‰å›åˆ: ${this.gameState.currentTurn}`);
                this.addGameLog(`å½“å‰ç©å®¶: ${this.getPlayerName(this.gameState.currentPlayer)}`);
            }

            updateGameUI(actionResult = null) {
                if (!this.gameState) return;

                // æ›´æ–°æ¸¸æˆçŠ¶æ€æ–‡æœ¬
                const statusText = document.getElementById('game-status-text');
                if (this.gameState.status === 'finished') {
                    statusText.textContent = 'æ¸¸æˆç»“æŸï¼';
                    this.showGameOver();
                    return;
                }

                const currentPlayerName = this.getPlayerName(this.gameState.currentPlayer);
                statusText.textContent = `å›åˆ ${this.gameState.currentTurn} - ${currentPlayerName} çš„å›åˆ`;

                // æ›´æ–°ç‰Œå †æ•°é‡
                document.getElementById('deck-count').textContent = `ğŸƒ ${this.gameState.deck.length}`;

                // æ›´æ–°å½“å‰ç©å®¶ä¿¡æ¯
                const currentPlayer = this.gameState.players.find(p => p.id === this.currentPlayer.id);
                if (currentPlayer) {
                    document.getElementById('current-player-coins').textContent = `ğŸ’° ${currentPlayer.coins}`;
                    
                    // æ›´æ–°ç©å®¶è‡ªå·±çš„å¡ç‰Œæ˜¾ç¤º
                    this.updatePlayerCards(currentPlayer);
                }

                // æ›´æ–°å…¶ä»–ç©å®¶ä¿¡æ¯
                this.updateOtherPlayers();

                // å¤„ç†è¡ŒåŠ¨ç»“æœ
                if (actionResult) {
                    actionResult.log.forEach(log => this.addGameLog(log));
                }

                // æ£€æŸ¥æŒ‘æˆ˜é˜¶æ®µ
                if (this.gameState.challengePhase && this.gameState.currentPlayer !== this.currentPlayer.id) {
                    this.showChallengePhase();
                } else {
                    document.getElementById('challenge-phase').classList.add('hidden');
                }

                // æ£€æŸ¥å¼ƒç‰Œé€‰æ‹©é˜¶æ®µ
                if (this.gameState.discardSelection && this.gameState.discardSelection.playerId === this.currentPlayer.id) {
                    this.showDiscardSelection();
                } else {
                    document.getElementById('discard-selection').classList.add('hidden');
                }

                // å¯ç”¨/ç¦ç”¨è¡ŒåŠ¨æŒ‰é’®
                this.updateActionButtons();
            }

            updateOtherPlayers() {
                const otherPlayersContainer = document.getElementById('other-players');
                otherPlayersContainer.innerHTML = '';

                this.gameState.players.forEach(player => {
                    if (player.id === this.currentPlayer.id) return;

                    const playerEl = document.createElement('div');
                    const isCurrentTurn = player.id === this.gameState.currentPlayer;
                    const isAlive = player.isAlive;
                    
                    playerEl.className = `p-3 rounded-lg flex justify-between items-center ${
                        isCurrentTurn ? 'bg-blue-900 border border-blue-500' : 
                        !isAlive ? 'bg-gray-900 border border-gray-700 opacity-50' : 
                        'bg-gray-700'
                    }`;
                    
                    playerEl.innerHTML = `
                        <div>
                            <div class="flex items-center">
                                <i class="fa fa-user-circle text-lg mr-2 ${isCurrentTurn ? 'text-blue-400' : 'text-gray-400'}"></i>
                                <span class="font-semibold ${!isAlive ? 'line-through' : ''}">${player.name}</span>
                                ${isCurrentTurn ? '<span class="ml-2 text-xs bg-blue-500 text-blue-900 px-2 py-1 rounded">å½“å‰</span>' : ''}
                            </div>
                            <div class="flex items-center mt-1">
                                <span class="text-sm text-accent mr-3">ğŸ’° ${player.coins}</span>
                                <div class="flex space-x-1">
                                    ${Array(player.cardsCount).fill().map(() => '<span class="text-sm">?</span>').join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    otherPlayersContainer.appendChild(playerEl);
                });
            }

            updateActionButtons() {
                const isCurrentTurn = this.gameState.currentPlayer === this.currentPlayer.id;
                const currentPlayer = this.gameState.players.find(p => p.id === this.currentPlayer.id);
                const isAlive = currentPlayer?.isAlive;
                const inChallengePhase = !!this.gameState.challengePhase;
                const inDiscardPhase = !!this.gameState.discardSelection;
                const inBlockPhase = !!this.gameState.blockPhase;

                document.querySelectorAll('.action-btn').forEach(btn => {
                    const disabled = !isCurrentTurn || !isAlive || inChallengePhase || inDiscardPhase || inBlockPhase;
                    btn.disabled = disabled;
                    btn.classList.toggle('opacity-50', disabled);
                });

                // å¦‚æœæ˜¯æ—è§‚è€…ï¼Œéšè—è¡ŒåŠ¨æŒ‰é’®åŒºåŸŸ
                const actionButtonsSection = document.getElementById('action-buttons');
                if (actionButtonsSection) {
                    actionButtonsSection.classList.toggle('hidden', !isAlive);
                }

                // æ˜¾ç¤ºæ—è§‚è€…æç¤º
                const spectatorNotice = document.getElementById('spectator-notice');
                if (!spectatorNotice && !isAlive) {
                    const notice = document.createElement('div');
                    notice.id = 'spectator-notice';
                    notice.className = 'bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-4 mb-4 text-center';
                    notice.innerHTML = `
                        <h4 class="font-semibold text-yellow-400 mb-2">
                            <i class="fa fa-eye mr-2"></i>æ—è§‚è€…æ¨¡å¼
                        </h4>
                        <p class="text-sm text-yellow-200">
                            ä½ å·²è¢«æ·˜æ±°ï¼Œä½†å¯ä»¥ç»§ç»­è§‚çœ‹æ¸¸æˆã€‚ä½ å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç©å®¶çš„å¡ç‰Œã€‚
                        </p>
                    `;
                    
                    // æ’å…¥åˆ°æ¸¸æˆç•Œé¢é¡¶éƒ¨
                    const gameInterface = document.getElementById('game-interface');
                    if (gameInterface) {
                        gameInterface.insertBefore(notice, gameInterface.firstChild);
                    }
                }
            }

            showChallengePhase() {
                const challengePhase = this.gameState.challengePhase;
                if (!challengePhase) return;

                const actionPlayerName = this.getPlayerName(challengePhase.action.playerId);
                const actionText = this.getActionText(challengePhase.action.action);
                
                document.getElementById('challenge-text').textContent = 
                    `${actionPlayerName} è¯•å›¾${actionText}ï¼Œä½ è¦æŒ‘æˆ˜è¿™ä¸ªè¡ŒåŠ¨å—ï¼Ÿ`;
                
                document.getElementById('countdown-timer').textContent = challengePhase.countdown || 20;
                
                // éšè—å…¶ä»–é˜¶æ®µ
                this.hideAllPhases();
                
                // å¼ºåˆ¶å¼¹å‡ºæŒ‘æˆ˜å¯¹è¯æ¡†å¹¶æ·»åŠ é†’ç›®çš„åŠ¨ç”»æ•ˆæœ
                const challengePhaseEl = document.getElementById('challenge-phase');
                challengePhaseEl.classList.remove('hidden');
                challengePhaseEl.classList.add('animate-pulse-slow', 'ring-4', 'ring-yellow-500');
                
                // 5ç§’åç§»é™¤åŠ¨ç”»æ•ˆæœ
                setTimeout(() => {
                    challengePhaseEl.classList.remove('animate-pulse-slow', 'ring-4', 'ring-yellow-500');
                }, 5000);
            }

            hideAllPhases() {
                document.getElementById('challenge-phase').classList.add('hidden');
                document.getElementById('counteraction-phase').classList.add('hidden');
                document.getElementById('discard-selection').classList.add('hidden');
                document.getElementById('target-selection').classList.add('hidden');
            }

            getActionText(action) {
                const actionTexts = {
                    'income': 'è·å¾—æ”¶å…¥',
                    'foreign_aid': 'è·å¾—å¤–å›½æ´åŠ©',
                    'coup': 'å‘åŠ¨æ”¿å˜',
                    'tax': 'å¾æ”¶ç¨é‡‘',
                    'assassinate': 'è¿›è¡Œåˆºæ€',
                    'exchange': 'äº¤æ¢å¡ç‰Œ',
                    'steal': 'è¿›è¡Œå·çªƒ'
                };
                return actionTexts[action] || action;
            }

            updateChallengeCountdown(countdown) {
                document.getElementById('countdown-timer').textContent = countdown;
                
                // æ·»åŠ å€’è®¡æ—¶åŠ¨ç”»æ•ˆæœ
                const timerEl = document.getElementById('countdown-timer');
                timerEl.classList.remove('animate-pulse');
                void timerEl.offsetWidth; // è§¦å‘é‡æ’
                timerEl.classList.add('animate-pulse');
                
                if (countdown <= 5) {
                    timerEl.classList.add('text-red-400');
                } else {
                    timerEl.classList.remove('text-red-400');
                }
            }

            updateCounteractionCountdown(countdown) {
                document.getElementById('counteraction-timer').textContent = countdown;
                
                // æ·»åŠ å€’è®¡æ—¶åŠ¨ç”»æ•ˆæœ
                const timerEl = document.getElementById('counteraction-timer');
                timerEl.classList.remove('animate-pulse');
                void timerEl.offsetWidth; // è§¦å‘é‡æ’
                timerEl.classList.add('animate-pulse');
                
                if (countdown <= 5) {
                    timerEl.classList.add('text-red-400');
                } else {
                    timerEl.classList.remove('text-red-400');
                }
            }

            showCounteractionPhase(data) {
                // éšè—å…¶ä»–é˜¶æ®µ
                this.hideAllPhases();
                
                // æ˜¾ç¤ºååˆ¶é˜¶æ®µ
                const counteractionPhase = document.getElementById('counteraction-phase');
                counteractionPhase.classList.remove('hidden');
                
                // è®¾ç½®ååˆ¶æ–‡æœ¬
                const counteractionText = document.getElementById('counteraction-text');
                counteractionText.textContent = data.message || `ä½ å¯ä»¥ä½¿ç”¨ ${data.counterRole} è¿›è¡Œååˆ¶å—ï¼Ÿ`;
                
                // è®¾ç½®å€’è®¡æ—¶
                document.getElementById('counteraction-timer').textContent = data.countdown;
                
                // ç»‘å®šååˆ¶æŒ‰é’®äº‹ä»¶
                document.getElementById('counteraction-yes-btn').onclick = () => this.handleCounteraction(true);
                document.getElementById('counteraction-no-btn').onclick = () => this.handleCounteraction(false);
            }

            handleCounteraction(counter) {
                console.log('å‘é€ååˆ¶å“åº”:', counter);
                this.socket.emit('counteraction', {
                    roomCode: this.currentRoom,
                    playerId: this.currentPlayer.id,
                    counter: counter
                });
                
                // éšè—ååˆ¶é˜¶æ®µ
                document.getElementById('counteraction-phase').classList.add('hidden');
            }
                } else {
                    timerEl.classList.remove('text-red-400');
                }
            }

            showDiscardSelection() {
                const discardSelection = this.gameState.discardSelection;
                if (!discardSelection) return;

                const currentPlayer = this.gameState.players.find(p => p.id === this.currentPlayer.id);
                if (!currentPlayer || !currentPlayer.cards) return;

                document.getElementById('discard-text').textContent = 
                    `ä½ è¢«${this.getPlayerName(discardSelection.action.playerId)}${this.getActionText(discardSelection.action.action)}ï¼Œè¯·é€‰æ‹©ä¸€å¼ å¡ç‰Œå¼ƒæ‰`;

                const cardsContainer = document.getElementById('discard-cards');
                cardsContainer.innerHTML = '';

                currentPlayer.cards.forEach((card, index) => {
                    const cardBtn = document.createElement('button');
                    cardBtn.className = 'discard-card-btn bg-blue-900 hover:bg-blue-800 p-4 rounded-xl transition-all flex flex-col items-center cursor-pointer';
                    cardBtn.innerHTML = `
                        <div class="w-16 h-20 bg-gradient-to-b from-blue-700 to-blue-900 rounded-lg border-2 border-blue-400 flex items-center justify-center mb-2 shadow-lg">
                            <span class="text-2xl font-bold text-white">${this.getCardDisplayName(card)}</span>
                        </div>
                        <span class="text-sm font-semibold">${this.getCardRoleName(card)}</span>
                    `;
                    cardBtn.addEventListener('click', () => this.selectDiscardCard(index));
                    cardsContainer.appendChild(cardBtn);
                });

                document.getElementById('discard-selection').classList.remove('hidden');
            }

            selectDiscardCard(cardIndex) {
                this.socket.emit('selectDiscard', {
                    roomCode: this.currentRoom,
                    playerId: this.currentPlayer.id,
                    cardIndex
                });
                document.getElementById('discard-selection').classList.add('hidden');
            }

            handleDiscardResult(result) {
                result.log.forEach(log => this.addGameLog(log));
            }

            updatePlayerCards(currentPlayer) {
                if (!currentPlayer || !currentPlayer.cards) return;

                const cardsContainer = document.querySelector('#current-player-info .flex.space-x-2');
                cardsContainer.innerHTML = '';

                currentPlayer.cards.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'w-12 h-16 bg-gradient-to-b from-blue-700 to-blue-900 rounded-lg border border-blue-300 flex items-center justify-center cursor-pointer hover:scale-110 transition-all card-flip';
                    cardEl.innerHTML = `
                        <div class="card-inner w-full h-full flex items-center justify-center">
                            <div class="card-front w-full h-full flex items-center justify-center">
                                <span class="text-2xl font-bold text-white">${this.getCardDisplayName(card)}</span>
                            </div>
                            <div class="card-back w-full h-full flex items-center justify-center transform rotate-y-180 absolute">
                                <span class="text-2xl">?</span>
                            </div>
                        </div>
                    `;
                    
                    // æ·»åŠ æ‚¬åœæç¤º
                    cardEl.title = this.getCardRoleName(card);
                    
                    cardsContainer.appendChild(cardEl);
                });

                // æ›´æ–°å¡ç‰Œæ•°é‡æç¤º
                document.getElementById('player-role-hint').textContent = 
                    `ä½ æœ‰ ${currentPlayer.cards.length} å¼ å¡ç‰Œ`;
            }

            getCardDisplayName(card) {
                const cardNames = {
                    'duke': 'å…¬çˆµ',
                    'assassin': 'åˆºå®¢',
                    'ambassador': 'å¤§ä½¿',
                    'captain': 'ä¸Šå°‰',
                    'contessa': 'å¥³çˆµ'
                };
                return cardNames[card] || card;
            }

            handleBlock(block) {
                this.socket.emit('blockResponse', {
                    roomCode: this.currentRoom,
                    playerId: this.currentPlayer.id,
                    block
                });
                document.getElementById('block-phase').classList.add('hidden');
            }

            showBlockPhase(data) {
                document.getElementById('block-text').textContent = data.message || 'ä½ å¯ä»¥é˜»æ­¢è¿™ä¸ªè¡ŒåŠ¨å—ï¼Ÿ';
                document.getElementById('block-timer').textContent = data.countdown || 15;
                document.getElementById('block-phase').classList.remove('hidden');
            }

            updateBlockCountdown(countdown) {
                document.getElementById('block-timer').textContent = countdown;
                
                // æ·»åŠ å€’è®¡æ—¶åŠ¨ç”»æ•ˆæœ
                const timerEl = document.getElementById('block-timer');
                timerEl.classList.remove('animate-pulse');
                void timerEl.offsetWidth; // è§¦å‘é‡æ’
                timerEl.classList.add('animate-pulse');
                
                if (countdown <= 5) {
                    timerEl.classList.add('text-red-400');
                } else {
                    timerEl.classList.remove('text-red-400');
                }
            }

            handleCardSwapped(data) {
                // æ·»åŠ å¡ç‰Œäº¤æ¢çš„æ¸¸æˆæ—¥å¿—
                this.addGameLog(data.message);
                
                // å¦‚æœæ˜¯å½“å‰ç©å®¶çš„å¡ç‰Œè¢«äº¤æ¢ï¼Œæ›´æ–°ç•Œé¢
                if (data.playerId === this.currentPlayer.id) {
                    // è§¦å‘å¡ç‰Œæ›´æ–°
                    this.updatePlayerCards();
                    
                    // æ˜¾ç¤ºå¡ç‰Œäº¤æ¢çš„è§†è§‰æ•ˆæœ
                    this.showCardSwapEffect();
                }
            }

            showCardSwapEffect() {
                const playerCardsContainer = document.getElementById('player-cards');
                if (playerCardsContainer) {
                    // æ·»åŠ é—ªçƒæ•ˆæœ
                    playerCardsContainer.classList.add('animate-pulse');
                    setTimeout(() => {
                        playerCardsContainer.classList.remove('animate-pulse');
                    }, 2000);
                }
            }

            getCardRoleName(card) {
                const roleNames = {
                    'duke': 'å…¬çˆµ - å¾ç¨+3é‡‘å¸ï¼Œé˜»æ­¢å¤–å›½æ´åŠ©',
                    'assassin': 'åˆºå®¢ - åˆºæ€-3é‡‘å¸ï¼Œç›®æ ‡å¼ƒç‰Œ',
                    'ambassador': 'å¤§ä½¿ - äº¤æ¢å¡ç‰Œï¼Œé˜»æ­¢å·çªƒ',
                    'captain': 'ä¸Šå°‰ - å·çªƒ+2é‡‘å¸ï¼Œé˜»æ­¢å·çªƒ',
                    'contessa': 'å¥³çˆµ - å…ç–«åˆºæ€'
                };
                return roleNames[card] || card;
            }

            showGameOver() {
                if (this.gameState.winner) {
                    const winnerName = this.getPlayerName(this.gameState.winner);
                    document.getElementById('winner-name').textContent = winnerName;
                    this.addGameLog(`æ¸¸æˆç»“æŸï¼èƒœåˆ©è€…æ˜¯ ${winnerName}ï¼`);
                    
                    // æ¸¸æˆç»“æŸåæ¸…é™¤å­˜å‚¨çš„çŠ¶æ€
                    this.clearGameState();
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
                    setTimeout(() => {
                        this.showScreen('game-over-screen');
                    }, 2000);
                }
            }

            // å­˜å‚¨æ¸¸æˆçŠ¶æ€åˆ°localStorage
            saveGameState(roomCode, playerId, playerName) {
                if (roomCode) localStorage.setItem('coup_roomCode', roomCode);
                if (playerId) localStorage.setItem('coup_playerId', playerId);
                if (playerName) localStorage.setItem('coup_playerName', playerName);
            }

            // æ¸…é™¤å­˜å‚¨çš„æ¸¸æˆçŠ¶æ€
            clearGameState() {
                localStorage.removeItem('coup_roomCode');
                localStorage.removeItem('coup_playerId');
                localStorage.removeItem('coup_playerName');
            }

            // é‡æ–°è¿æ¥åˆ°æ¸¸æˆ
            reconnectToGame(roomCode, playerId, playerName) {
                console.log('å°è¯•é‡æ–°è¿æ¥åˆ°æ¸¸æˆ:', { roomCode, playerId, playerName });
                
                this.currentRoom = roomCode;
                this.currentPlayer = {
                    id: playerId,
                    name: playerName,
                    isHost: false // é‡è¿æ—¶å…ˆè®¾ä¸ºfalseï¼Œè¿æ¥æˆåŠŸåä¼šæ›´æ–°
                };
                
                this.connectToSocket();
                this.joinSocketRoom(roomCode, playerName, playerId);
                
                // æ˜¾ç¤ºåŠ è½½ç•Œé¢
                this.showReconnectingScreen();
            }

            // æ˜¾ç¤ºé‡è¿ä¸­ç•Œé¢
            showReconnectingScreen() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="text-center py-16">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
                        <h2 class="text-2xl font-bold mb-4">æ­£åœ¨é‡æ–°è¿æ¥åˆ°æ¸¸æˆ...</h2>
                        <p class="text-gray-300">æˆ¿é—´ä»£ç : ${this.currentRoom}</p>
                        <p class="text-gray-400 mt-4">å¦‚æœé•¿æ—¶é—´æ— æ³•è¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°åŠ å…¥</p>
                        <button id="cancel-reconnect-btn" class="mt-6 px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all">
                            å–æ¶ˆé‡è¿
                        </button>
                    </div>
                `;
                
                // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
                document.getElementById('cancel-reconnect-btn').addEventListener('click', () => {
                    this.clearGameState();
                    location.reload();
                });
            }

            getPlayerName(playerId) {
                const player = this.gameState.players.find(p => p.id === playerId);
                return player ? player.name : 'Unknown';
            }

            copyRoomCode() {
                const code = document.getElementById('room-code-display').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    this.showSuccess('æˆ¿é—´ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    this.showError('å¤åˆ¶å¤±è´¥');
                });
            }

            playAgain() {
                // è¿™é‡Œåº”è¯¥å®ç°é‡æ–°å¼€å§‹æ¸¸æˆçš„é€»è¾‘
                this.showError('åŠŸèƒ½å¼€å‘ä¸­');
            }

            backToMenu() {
                this.leaveRoom();
            }

            showScreen(screenId) {
                document.querySelectorAll('#app > div').forEach(div => {
                    div.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            addGameLog(message, type = 'info') {
                const logContainer = document.getElementById('game-log');
                const logEntry = document.createElement('div');
                
                let textColor = 'text-gray-300';
                let icon = 'fa-circle';
                
                switch (type) {
                    case 'success':
                        textColor = 'text-green-400';
                        icon = 'fa-check-circle';
                        break;
                    case 'error':
                        textColor = 'text-red-400';
                        icon = 'fa-exclamation-circle';
                        break;
                    case 'warning':
                        textColor = 'text-yellow-400';
                        icon = 'fa-exclamation-triangle';
                        break;
                    case 'action':
                        textColor = 'text-blue-400';
                        icon = 'fa-bolt';
                        break;
                    case 'counter':
                        textColor = 'text-purple-400';
                        icon = 'fa-shield';
                        break;
                    case 'challenge':
                        textColor = 'text-orange-400';
                        icon = 'fa-question-circle';
                        break;
                }
                
                logEntry.className = `flex items-start ${textColor}`;
                logEntry.innerHTML = `
                    <i class="fa ${icon} mr-2 mt-1"></i>
                    <span>${message}</span>
                `;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
                if (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }

            showNotification(message, type = 'info') {
                const logContainer = document.getElementById('game-log');
                const logEntry = document.createElement('div');
                
                let textColor = 'text-gray-300';
                let icon = 'fa-circle';
                
                switch (type) {
                    case 'success':
                        textColor = 'text-green-400';
                        icon = 'fa-check-circle';
                        break;
                    case 'error':
                        textColor = 'text-red-400';
                        icon = 'fa-exclamation-circle';
                        break;
                    case 'warning':
                        textColor = 'text-yellow-400';
                        icon = 'fa-exclamation-triangle';
                        break;
                    case 'action':
                        textColor = 'text-blue-400';
                        icon = 'fa-bolt';
                        break;
                    case 'counter':
                        textColor = 'text-purple-400';
                        icon = 'fa-shield';
                        break;
                    case 'challenge':
                        textColor = 'text-orange-400';
                        icon = 'fa-question-circle';
                        break;
                }
                
                logEntry.className = `flex items-start ${textColor}`;
                logEntry.innerHTML = `
                    <i class="fa ${icon} mr-2 mt-1"></i>
                    <span>${message}</span>
                `;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
                if (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
                // ç®€å•çš„é€šçŸ¥å®ç°
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0 ${
                    type === 'error' ? 'bg-red-600' : 
                    type === 'success' ? 'bg-green-600' : 
                    'bg-blue-600'
                }`;
                notification.textContent = message;
                document.body.appendChild(notification);

                // æ˜¾ç¤ºé€šçŸ¥
                setTimeout(() => {
                    notification.classList.remove('translate-x-full', 'opacity-0');
                }, 100);

                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    notification.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', () => {
            window.coupGame = new CoupGame();
        });
    </script>
</body>
</html>